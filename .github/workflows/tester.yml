name: Test and validate code

on:
  workflow_call:
    inputs:
      kmom_paths:
        required: true
        type: string
    outputs:
      tests_passed:
        description: "Whether all validation and tests passed"
        value: ${{ jobs.check-results.outputs.tests_passed }}

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      kmoms: ${{ steps.set-matrix.outputs.kmoms }}

    steps:
      - name: Extract kmom based on tag
        id: set-matrix
        run: |
          if [[ "$GITHUB_REF" == *"refs/tags/"* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"   # Remove refs/tags/
            NUM=$(echo "$TAG" | sed -E 's/^v([0-9]+).*/\1/')
            echo "First number after v: $NUM"
            PADDED=$(printf "%02d" "$NUM")
            KMOM="kmom$PADDED"
            echo "Result tag: $KMOM"
          else
            KMOM="${GITHUB_BASE_REF#bth/submit/}"   # Remove bth/submit/ from base ref
            echo "Result branch: $KMOM"
          fi


          KMOMS=$(echo '${{ inputs.kmom_paths }}' | jq -c --arg b "$KMOM" '.[$b].kmoms // []')

          echo "‚úÖ Kmom: kmom$PADDED"

          echo "kmoms={\"folder\":$KMOMS}" >> $GITHUB_OUTPUT

  run-kmoms:
    needs: [generate-matrix]
    if: needs.generate-matrix.outputs.kmoms != '{"folder":[]}'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.kmoms) }}

    steps:
      - name: setup-python
        uses: bth-python/utils/.github/actions/setup-python@main

      - name: "Validate code"
        run: uv run ruff check $(echo "${{ matrix.folder }}" | sed 's/tests/src/')

      - name: Run kmom test in ${{ matrix.folder }}
        run: |
          echo "üî¨ Running kmom: ${{ matrix.folder }}"
          uv run tester -f ${{ matrix.folder }}

      - name: Run extra tests in ${{ matrix.folder }}
        continue-on-error: true
        run: |
          echo "üî¨ Running extras: ${{ matrix.folder }}. It is OK if these tests fail. It will not affect your grade"
          uv run tester -f -e ${{ matrix.folder }}

  check-results:
    needs: [run-kmoms]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.set-output.outputs.tests_passed }}
    steps:
      - name: Check if tests passed
        id: set-output
        run: |
          if [[ "${{ needs.run-kmoms.result }}" == "success" ]]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All validation and tests passed"
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Validation or tests failed"
          fi
