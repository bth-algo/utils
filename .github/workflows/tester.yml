name: Test and validate code

on:
  workflow_call:
    inputs:
      kmom_paths:
        required: true
        type: string
    outputs:
      tests_passed:
        description: "Whether all validation and tests passed"
        value: ${{ jobs.check-results.outputs.tests_passed }}
      test_summary:
        description: "Human-readable summary of test results"
        value: ${{ jobs.check-results.outputs.test_summary }}

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      kmoms: ${{ steps.set-matrix.outputs.kmoms }}

    steps:
      - name: Extract kmom based on tag
        id: set-matrix
        run: |
          if [[ "$GITHUB_REF" == *"refs/tags/"* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"   # Remove refs/tags/
            NUM=$(echo "$TAG" | sed -E 's/^v([0-9]+).*/\1/')
            echo "First number after v: $NUM"
            PADDED=$(printf "%02d" "$NUM")
            KMOM="kmom$PADDED"
            echo "Result tag: $KMOM"
          else
            KMOM="${GITHUB_BASE_REF#bth/submit/}"   # Remove bth/submit/ from base ref
            echo "Result branch: $KMOM"
          fi


          KMOMS=$(echo '${{ inputs.kmom_paths }}' | jq -c --arg b "$KMOM" '.[$b].kmoms // []')

          echo "âœ… Kmom: kmom$PADDED"

          echo "kmoms={\"folder\":$KMOMS}" >> $GITHUB_OUTPUT

  run-kmoms:
    needs: [generate-matrix]
    if: needs.generate-matrix.outputs.kmoms != '{"folder":[]}'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.kmoms) }}

    steps:
      - name: setup-python
        uses: bth-python/utils/.github/actions/setup-python@main

      - name: "Validate code"
        run: uv run ruff check $(echo "${{ matrix.folder }}" | sed 's/tests/src/')

      - name: Run kmom test in ${{ matrix.folder }}
        run: |
          echo "ğŸ”¬ Running kmom: ${{ matrix.folder }}"
          uv run tester -f ${{ matrix.folder }}

      - name: Run extra tests in ${{ matrix.folder }}
        continue-on-error: true
        run: |
          echo "ğŸ”¬ Running extras: ${{ matrix.folder }}. It is OK if these tests fail. It will not affect your grade"
          uv run tester -f -e ${{ matrix.folder }}

  check-results:
    needs: [run-kmoms]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.set-output.outputs.tests_passed }}
      test_summary: ${{ steps.set-output.outputs.test_summary }}
    steps:
      - name: Check if tests passed and build summary
        id: set-output
        uses: actions/github-script@v7
        env:
          RUN_KMOMS_RESULT: ${{ needs.run-kmoms.result }}
        with:
          github-token: ${{ secrets.READ_ORG_TOKEN }}
          script: |
            const result = process.env.RUN_KMOMS_RESULT;
            const passed = result === 'success';
            core.setOutput('tests_passed', passed ? 'true' : 'false');
            if (passed) {
              console.log('âœ… All validation and tests passed');
            } else {
              console.log('âŒ Validation or tests failed');
            }

            // Query jobs for this run to build a per-folder summary
            const { data: { jobs } } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              per_page: 100
            });

            const kmomJobs = jobs.filter(j => j.name.includes('run-kmoms'));

            const summaryLines = kmomJobs.map(job => {
              const folderMatch = job.name.match(/\((.+)\)/);
              const folder = folderMatch ? folderMatch[1] : job.name;
              const jobEmoji = job.conclusion === 'success' ? 'âœ…' : 'âŒ';
              const lines = [`- ${jobEmoji} **${folder}** ([view output](${job.html_url}))`];

              for (const step of (job.steps || [])) {
                if (step.name === 'Validate code') {
                  const e = step.conclusion === 'success' ? 'âœ…' : 'âŒ';
                  lines.push(`  - ${e} \`uv run ruff check ${folder.replace('tests', 'src')}\``);
                } else if (step.name && step.name.startsWith('Run kmom test')) {
                  const e = step.conclusion === 'success' ? 'âœ…' : 'âŒ';
                  lines.push(`  - ${e} \`uv run tester -f ${folder}\``);
                }
              }
              return lines.join('\n');
            });

            const testSummary = summaryLines.length > 0
              ? `**Test results:**\n${summaryLines.join('\n')}`
              : passed ? '**Test results:** âœ… All tests passed' : '**Test results:** âŒ Tests failed (no job details available)';
            core.setOutput('test_summary', testSummary);
