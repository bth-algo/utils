name: Run tester when labeled

on:
  workflow_call:
    inputs:
      course_id:
        required: true
        type: string
      available_assignments:
        required: true
        type: string
      student_id:
        required: true
        type: string
      kmom_paths:
        required: true
        type: string

jobs:
  check-label-and-auth:
    runs-on: ubuntu-latest
    outputs:
      is_allowed_label: ${{ steps.check-label.outputs.is_allowed }}
      is_teacher: ${{ steps.check-team.outputs.is_teacher }}
      label_name: ${{ steps.check-label.outputs.label_name }}
    steps:
      - name: Check if label is in allowed list
        id: check-label
        run: |
          label="${{ github.event.label.name }}"
          # List of labels that students are allowed to set
          allowed_labels=("Run tests")
          
          echo "label_name=$label" >> "$GITHUB_OUTPUT"
          
          is_allowed=false
          for allowed in "${allowed_labels[@]}"; do
            if [[ "$label" == "$allowed" ]]; then
              is_allowed=true
              break
            fi
          done
          
          echo "is_allowed=$is_allowed" >> "$GITHUB_OUTPUT"
          echo "Label '$label' allowed for students: $is_allowed"

      - name: Check if user is in teacher team
        id: check-team
        if: steps.check-label.outputs.is_allowed == 'false'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.READ_ORG_TOKEN }}
        run: |
          user="${{ github.event.sender.login }}"
          echo "Checking if $user is in teacher team..."
          
          status=$(gh api orgs/bth-algo/teams/teacher/memberships/$user --jq '.state' 2>/dev/null || echo "not_found")
          
          if [[ "$status" == "active" ]]; then
            echo "is_teacher=true" >> "$GITHUB_OUTPUT"
            echo "✅ User $user is a teacher"
          else
            echo "is_teacher=false" >> "$GITHUB_OUTPUT"
            echo "❌ User $user is not a teacher"
          fi

  run-tester:
    needs: check-label-and-auth
    if: needs.check-label-and-auth.outputs.is_allowed_label == 'true'
    uses: bth-algo/utils/.github/workflows/tester.yml@main
    with:
      kmom_paths: ${{ inputs.kmom_paths }}
    secrets: inherit

  submit-grade:
    needs: check-label-and-auth
    if: needs.check-label-and-auth.outputs.label_name == 'Graded' && needs.check-label-and-auth.outputs.is_teacher == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Get all labels and find grade
        id: find-grade
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.READ_ORG_TOKEN }}
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            console.log('All labels:', labels);
            
            const gradeLabel = labels.find(l => l.startsWith('Grade: '));
            
            if (!gradeLabel) {
              core.setFailed('No "Grade: X" label found. Please add a grade label (e.g., "Grade: PG", "Grade: F")');
              return;
            }
            
            const grade = gradeLabel.replace('Grade: ', '');
            console.log('Extracted grade:', grade);
            core.setOutput('grade', grade);

      - name: Get PR details
        id: get-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.READ_ORG_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const baseRef = pr.base.ref;
            
            // Extract kmom from base branch (e.g., bth/submit/kmom03 -> kmom03)
            const kmomMatch = baseRef.match(/bth\/submit\/(kmom\d+)/);
            if (!kmomMatch) {
              core.setFailed(`Invalid base branch format: ${baseRef}`);
              return;
            }
            
            const kmom = kmomMatch[1];
            core.setOutput('kmom', kmom);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || '');
            core.setOutput('pr_url', pr.html_url);

      - name: Create submission body
        id: create-body
        run: |
          cat << EOF >> $GITHUB_OUTPUT
          myoutput<<EOM
          <h2>Grade: ${{ steps.find-grade.outputs.grade }}</h2>
          <br>
          <h3>${{ steps.get-pr.outputs.pr_title }}</h3>
          ${{ steps.get-pr.outputs.pr_body }}<br>
          <br>
          PR URL: <a class='inline_disabled' href='${{ steps.get-pr.outputs.pr_url }}' target='_blank' rel='noopener noreferrer'>${{ steps.get-pr.outputs.pr_url }}</a>
          EOM
          EOF

      - name: Resolve assignment ID
        uses: bth-python/utils/.github/actions/get-assignment-id@main
        id: resolve
        with:
          available_assignments: ${{ inputs.available_assignments }}

      - name: Submit grade to Canvas
        uses: bth-python/utils/.github/actions/update-canvas@main
        id: update_canvas
        with:
          subcommand: "grade_submission"
          comment: "${{ steps.create-body.outputs.myoutput }}"
          canvas_api_token: ${{ secrets.CANVAS_API_TOKEN }}
          student_id: ${{ inputs.student_id }}
          course_id: ${{ inputs.course_id }}
          assignment_id: ${{ steps.resolve.outputs.assignment }}
          grade: ${{ steps.find-grade.outputs.grade }}
          read_org_token: "${{ secrets.READ_ORG_TOKEN }}"

      - name: Comment on PR about grading
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.READ_ORG_TOKEN }}
          script: |
            const grade = '${{ steps.find-grade.outputs.grade }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ Grade **${grade}** has been submitted to Canvas.`
            });
        continue-on-error: true

  remove-unauthorized-label:
    needs: check-label-and-auth
    if: needs.check-label-and-auth.outputs.is_allowed_label == 'false' && needs.check-label-and-auth.outputs.is_teacher != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Remove unauthorized label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: ${{ needs.check-label-and-auth.outputs.label_name }}
        continue-on-error: true

      - name: Comment on PR about unauthorized label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.READ_ORG_TOKEN }}
          script: |
            const labelName = '${{ needs.check-label-and-auth.outputs.label_name }}';
            const user = '${{ github.event.sender.login }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ The label "${labelName}" was removed because only teachers can set this label.\n\n@${user} - You can use the "Run tests" label to trigger test execution.`
            });
        continue-on-error: true
